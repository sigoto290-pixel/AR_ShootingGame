using System.Collections.Generic;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.EventSystems;

public class WorldButton : MonoBehaviour,IPointerDownHandler,IPointerEnterHandler,IPointerExitHandler,IPointerUpHandler
{
    [SerializeField] Collider[] _colliders;
    [SerializeField] UnityEvent _unityEvent;
    [SerializeField] SpriteRenderer _frontSprite;
    [SerializeField] Transform _buttonTr;
    [SerializeField] Color _downColor;
    [SerializeField] Vector3 _offset = new Vector3(0, -0.35f, 0);

    Color _startColor;
    Vector3 _startPosition;
    static GameObject _pointerCurrentRaycastObj;
    static int _downCount;
    void Start()
    {
        _startColor = _frontSprite.color;
        _startPosition = _buttonTr.localPosition;
    }
    void Update()
    {
        if(_pointerCurrentRaycastObj == null) return;
        Debug.Log(_pointerCurrentRaycastObj.name,_pointerCurrentRaycastObj);
        foreach(Collider collider in _colliders)
        {
            if(collider.gameObject == _pointerCurrentRaycastObj)
            {
                _unityEvent.Invoke();
                SetUpState();
                _pointerCurrentRaycastObj = null;
                _downCount = 0;
            }
        }
    }
    //ほかのボタンにより、この自作コンポーネントにアタッチされたゲームオブジェクトが有効化された時、リセットする処理
    void OnEnable()
    {
        SetUpState();
    }
    public void OnPointerDown(PointerEventData pointerEventData)
    {
        SetDownState();
        _downCount++;
    }
    public void OnPointerEnter(PointerEventData pointerEventData)
    {
        if(_downCount > 0)
        {
            SetDownState();
        }
    }
    public void OnPointerExit(PointerEventData pointerEventData)
    {
        if(_downCount > 0)
        {
            SetUpState();
        }
    }
    public void OnPointerUp(PointerEventData pointerEventData)
    {
        _pointerCurrentRaycastObj = pointerEventData.pointerCurrentRaycast.gameObject;
        _downCount --;
    }
    private void SetDownState()
    {
        _frontSprite.color = _downColor;
        _buttonTr.localPosition = _startPosition + _offset;
    }

    private void SetUpState()
    {
        _frontSprite.color = _startColor;
        _buttonTr.localPosition = _startPosition;
    }

}
